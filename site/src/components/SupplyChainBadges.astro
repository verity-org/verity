---
import CopyButton from "./CopyButton.astro";

interface Props {
  /** Full artifact reference, e.g. ghcr.io/verity-org/grafana/grafana:11.6.0-patched */
  artifactRef: string;
}

const { artifactRef } = Astro.props;
const base = import.meta.env.BASE_URL;

// GitHub owner/repo for attestation verification.
const owner = "verity-org";
const repo = "verity";

const cosignCmd = `cosign verify \\\n  --certificate-identity-regexp "https://github.com/${owner}/${repo}/.github/workflows/" \\\n  --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \\\n  ${artifactRef}`;
const cosignCopy = `cosign verify --certificate-identity-regexp "https://github.com/${owner}/${repo}/.github/workflows/" --certificate-oidc-issuer "https://token.actions.githubusercontent.com" ${artifactRef}`;

const ghCmd = `gh attestation verify \\\n  oci://${artifactRef} \\\n  --owner ${owner}`;
const ghCopy = `gh attestation verify oci://${artifactRef} --owner ${owner}`;
---

<div class="bg-verity-surface border border-verity-border rounded-lg p-4">
  <div class="flex items-center justify-between mb-3">
    <div class="text-xs text-verity-text-secondary uppercase tracking-wide font-medium">
      Supply Chain
    </div>
    <a
      href={`${base}compliance/`}
      class="text-xs text-verity-text-muted hover:text-verity-nucleus transition-colors underline"
    >
      Full compliance details
    </a>
  </div>
  <div class="flex flex-wrap gap-2 mb-3">
    <span
      class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-950/40 text-green-400 border border-green-800/50"
    >
      <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      Signed
    </span>
    <span
      class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-950/40 text-green-400 border border-green-800/50"
    >
      <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      SLSA L3
    </span>
    <span
      class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-950/40 text-green-400 border border-green-800/50"
    >
      <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      SBOM
    </span>
    <span
      class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-950/40 text-green-400 border border-green-800/50"
    >
      <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      Rekor
    </span>
  </div>
  <details class="text-sm text-verity-text-muted">
    <summary class="cursor-pointer hover:text-verity-nucleus font-medium text-verity-text-secondary"
      >Verify this artifact</summary
    >
    <div class="mt-3 space-y-3">
      <div>
        <div class="text-xs text-verity-text-muted mb-1">Cosign signature</div>
        <div
          class="bg-verity-void text-verity-text-primary border border-verity-border rounded p-3 font-mono text-xs overflow-x-auto flex items-start justify-between gap-3"
        >
          <pre class="whitespace-pre-wrap break-all" set:text={cosignCmd} />
          <CopyButton text={cosignCopy} />
        </div>
      </div>
      <div>
        <div class="text-xs text-verity-text-muted mb-1">Build provenance</div>
        <div
          class="bg-verity-void text-verity-text-primary border border-verity-border rounded p-3 font-mono text-xs overflow-x-auto flex items-start justify-between gap-3"
        >
          <pre class="whitespace-pre-wrap break-all" set:text={ghCmd} />
          <CopyButton text={ghCopy} />
        </div>
      </div>
    </div>
  </details>
</div>
