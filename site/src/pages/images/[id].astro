---
import BaseLayout from "../../layouts/BaseLayout.astro";
import VulnTable from "../../components/VulnTable.astro";
import SeverityBreakdown from "../../components/SeverityBreakdown.astro";
import CopyButton from "../../components/CopyButton.astro";
import SupplyChainBadges from "../../components/SupplyChainBadges.astro";
import { getAllImages, shortName } from "../../lib/catalog";
import type { SiteImage } from "../../lib/catalog";

export function getStaticPaths() {
  const all = getAllImages();
  return all.map((image) => ({
    params: { id: image.id },
    props: { image },
  }));
}

interface Props {
  image: SiteImage;
}

const { image } = Astro.props;
const base = import.meta.env.BASE_URL;
const display = shortName(image.originalRef);
const fixed = image.beforeVulns.total - image.afterVulns.total;
const remaining = image.afterVulns.total;

// Split remaining vulns: those with an upstream fix (Copa couldn't apply) vs. no fix yet
const pendingVulns = image.vulnerabilities.filter((v) => v.fixedVersion);
const awaitingFixVulns = image.vulnerabilities.filter((v) => !v.fixedVersion);
---

<BaseLayout title={`${display} — Verity`}>
  <nav class="text-sm text-verity-text-secondary mb-6">
    <a href={base} class="hover:text-verity-nucleus transition-colors">Home</a>
    <span class="mx-1">/</span>
    <span class="text-verity-text-primary truncate">{display.split("/").pop()?.split(":")[0]}</span>
  </nav>

  <div class="mb-6">
    <h1 class="text-xl font-bold font-mono break-all mb-2 text-verity-text-primary">
      {image.originalRef}
    </h1>
    <div class="flex items-center gap-3 flex-wrap">
      {image.os && <span class="text-sm text-verity-text-secondary">Base OS: {image.os}</span>}
      {
        fixed > 0 ? (
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-sm font-medium bg-green-950/40 text-green-400 border border-green-800/50">
            <svg
              class="w-4 h-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2.5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            {fixed} vulnerabilit{fixed === 1 ? "y" : "ies"} fixed
          </span>
        ) : (
          <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-sm font-medium bg-green-950/40 text-green-400 border border-green-800/50">
            <svg
              class="w-4 h-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2.5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            clean
          </span>
        )
      }
    </div>
  </div>

  <div class="bg-verity-surface border border-verity-nucleus/30 rounded-lg p-4 mb-4">
    <div class="text-xs text-verity-nucleus uppercase tracking-wide font-medium mb-1">
      Patched Image
    </div>
    <div class="font-mono text-sm break-all text-verity-text-primary">{image.patchedRef}</div>
    <div class="mt-2">
      <CopyButton text={image.patchedRef} />
    </div>
  </div>

  <div class="mb-8">
    <SupplyChainBadges artifactRef={image.patchedRef} />
  </div>

  {
    image.beforeVulns.total > 0 && (
      <div class="mb-8">
        <h2 class="text-lg font-semibold mb-1 text-verity-text-primary">Before patching</h2>
        <p class="text-sm text-verity-text-muted mb-3">
          {fixed > 0 ? (
            <>
              Found {image.beforeVulns.total} vulnerabilit
              {image.beforeVulns.total === 1 ? "y" : "ies"} in the original image.
              <span class="text-verity-nucleus font-medium"> {fixed} fixed by Copa.</span>
              {remaining > 0 && (
                <span class="text-verity-text-secondary">
                  {" "}
                  {remaining} remaining after patching.
                </span>
              )}
            </>
          ) : (
            <>
              Found {image.beforeVulns.total} vulnerabilit
              {image.beforeVulns.total === 1 ? "y" : "ies"} — none have upstream fixes available.
            </>
          )}
        </p>
        <SeverityBreakdown summary={image.beforeVulns} />
      </div>
    )
  }

  {
    pendingVulns.length > 0 && (
      <section class="mb-8">
        <h2 class="text-lg font-semibold mb-1 text-verity-text-primary">
          Fix available — pending patch
        </h2>
        <p class="text-sm text-verity-text-muted mb-3">
          These vulnerabilities have upstream fixes but could not be automatically patched. Manual
          remediation may be required.
        </p>
        <VulnTable vulnerabilities={pendingVulns} />
      </section>
    )
  }

  {
    awaitingFixVulns.length > 0 && (
      <section class="mb-8">
        <h2 class="text-lg font-semibold mb-1 text-verity-text-primary">Awaiting upstream fix</h2>
        <p class="text-sm text-verity-text-muted mb-3">
          No fix is available yet for these vulnerabilities. They can be suppressed in your
          compliance tooling until an upstream fix is released.
        </p>
        <VulnTable vulnerabilities={awaitingFixVulns} />
      </section>
    )
  }

  <div class="mt-8 pt-6 border-t border-verity-border">
    <details class="text-sm text-verity-text-secondary">
      <summary class="cursor-pointer hover:text-verity-nucleus transition-colors"
        >Original image reference</summary
      >
      <div
        class="mt-2 font-mono text-xs break-all bg-verity-surface border border-verity-border p-3 rounded text-verity-text-muted"
      >
        {image.originalRef}
      </div>
    </details>
  </div>
</BaseLayout>
