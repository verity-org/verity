---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import ImageRow from "../../../components/ImageRow.astro";
import CopyButton from "../../../components/CopyButton.astro";
import SearchFilter from "../../../components/SearchFilter.astro";
import SupplyChainBadges from "../../../components/SupplyChainBadges.astro";
import { catalog } from "../../../lib/catalog";
import type { SiteChart } from "../../../lib/catalog";

export function getStaticPaths() {
  return (catalog.charts ?? []).map((chart) => ({
    params: { name: chart.name, version: chart.version },
    props: { chart },
  }));
}

interface Props {
  chart: SiteChart;
}

const { chart } = Astro.props;
const base = import.meta.env.BASE_URL;
const totalVulns = chart.images.reduce((sum, img) => sum + img.vulnSummary.total, 0);
const chartOciRef = `${catalog.registry}/charts/${chart.name}:${chart.version}`;
---

<BaseLayout title={`${chart.name} v${chart.version} â€” Verity`}>
  <nav class="text-sm text-gray-500 mb-6">
    <a href={base} class="hover:text-gray-700">Home</a>
    <span class="mx-1">/</span>
    <a href={`${base}charts/${chart.name}/`} class="hover:text-gray-700">{chart.name}</a>
    <span class="mx-1">/</span>
    <span class="text-gray-900">v{chart.version}</span>
  </nav>

  <div class="mb-8">
    <h1 class="text-2xl font-bold mb-1">{chart.name}</h1>
    <p class="text-gray-500 mb-4">
      v{chart.version}
      {
        chart.upstreamVersion && (
          <span class="text-gray-400 ml-2">(upstream {chart.upstreamVersion})</span>
        )
      }
    </p>

    {
      chart.helmInstall && (
        <div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between gap-4 mb-4">
          <code class="text-sm font-mono text-gray-700 break-all">{chart.helmInstall}</code>
          <CopyButton text={chart.helmInstall} />
        </div>
      )
    }

    <SupplyChainBadges artifactRef={chartOciRef} kind="chart" />
  </div>

  <section>
    <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
      <h2 class="text-lg font-semibold">
        Container Images ({chart.images.length})
        {
          totalVulns > 0 && (
            <span class="text-sm font-normal text-gray-500 ml-2">{totalVulns} vulns patched</span>
          )
        }
      </h2>
      {chart.images.length > 3 && <SearchFilter targetId="chart-images" />}
    </div>
    <div id="chart-images" class="space-y-2">
      {chart.images.map((image) => <ImageRow image={image} />)}
    </div>
  </section>
</BaseLayout>
