---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { catalog, getChartNames, getChartVersions } from '../../../lib/catalog';
import type { SiteChart } from '../../../lib/catalog';

export function getStaticPaths() {
  return getChartNames().map((name) => ({
    params: { name },
    props: { name, versions: getChartVersions(name) },
  }));
}

interface Props {
  name: string;
  versions: SiteChart[];
}

const { name, versions } = Astro.props;
const base = import.meta.env.BASE_URL;
---

<BaseLayout title={`${name} â€” Verity`}>
  <nav class="text-sm text-gray-500 mb-6">
    <a href={base} class="hover:text-gray-700">Home</a>
    <span class="mx-1">/</span>
    <span class="text-gray-900">{name}</span>
  </nav>

  <div class="mb-8">
    <h1 class="text-2xl font-bold mb-1">{name}</h1>
    <p class="text-gray-500">{versions.length} version{versions.length !== 1 ? 's' : ''}</p>
  </div>

  <section>
    <h2 class="text-lg font-semibold mb-4">Versions</h2>
    <div class="space-y-3">
      {versions.map((chart) => {
        const totalVulns = chart.images.reduce((sum, img) => sum + img.vulnSummary.total, 0);
        return (
          <a
            href={`${base}charts/${name}/${chart.version}/`}
            class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-gray-400 hover:shadow-sm transition-all"
          >
            <div>
              <span class="font-semibold text-gray-900">v{chart.version}</span>
              {chart.upstreamVersion && (
                <span class="text-sm text-gray-400 ml-2">(upstream {chart.upstreamVersion})</span>
              )}
            </div>
            <div class="flex items-center gap-3 text-sm text-gray-600">
              <span>{chart.images.length} images</span>
              <span class="text-gray-300">|</span>
              {totalVulns > 0 ? (
                <span class="text-orange-600">{totalVulns} vulns patched</span>
              ) : (
                <span class="text-green-600">clean</span>
              )}
            </div>
          </a>
        );
      })}
    </div>
  </section>
</BaseLayout>
