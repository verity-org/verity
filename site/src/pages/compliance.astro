---
import BaseLayout from '../layouts/BaseLayout.astro';
import CopyButton from '../components/CopyButton.astro';

const base = import.meta.env.BASE_URL;
---

<BaseLayout title="Supply Chain Compliance â€” Verity">
  <nav class="text-sm text-gray-500 mb-6">
    <a href={base} class="hover:text-gray-700">Home</a>
    <span class="mx-1">/</span>
    <span class="text-gray-900">Compliance</span>
  </nav>

  <div class="mb-10">
    <h1 class="text-3xl font-bold mb-2">Supply Chain Compliance</h1>
    <p class="text-gray-600 text-lg">
      Every artifact published by Verity is signed, attested, and verifiable.
      This page details the security controls in place and the frameworks they satisfy.
    </p>
  </div>

  <!-- Compliance status badges -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-12">
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
      <div class="text-lg font-bold text-green-800">SLSA L3</div>
      <div class="text-sm text-green-600">Build Provenance</div>
    </div>
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
      <div class="text-lg font-bold text-green-800">Cosign</div>
      <div class="text-sm text-green-600">Keyless Signing</div>
    </div>
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
      <div class="text-lg font-bold text-green-800">CycloneDX</div>
      <div class="text-sm text-green-600">SBOM Attested</div>
    </div>
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
      <div class="text-lg font-bold text-green-800">Rekor</div>
      <div class="text-sm text-green-600">Transparency Log</div>
    </div>
  </div>

  <!-- SLSA -->
  <section class="mb-10">
    <h2 class="text-xl font-semibold mb-1">SLSA Level 3 &mdash; Build Integrity</h2>
    <p class="text-sm text-gray-500 mb-4">
      <a href="https://slsa.dev/spec/v1.0/" class="underline hover:text-gray-700">Supply-chain Levels for Software Artifacts (SLSA) v1.0</a>
    </p>
    <div class="bg-gray-50 rounded-lg p-6 space-y-4">
      <div class="grid sm:grid-cols-3 gap-4">
        <div>
          <div class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-1">Build L1</div>
          <div class="font-medium">Provenance Exists</div>
          <p class="text-sm text-gray-500">Every container image and Helm chart has an attached SLSA provenance attestation generated at build time.</p>
        </div>
        <div>
          <div class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-1">Build L2</div>
          <div class="font-medium">Hosted Build Platform</div>
          <p class="text-sm text-gray-500">All builds execute on GitHub Actions using ephemeral, GitHub-hosted runners with no self-hosted infrastructure.</p>
        </div>
        <div>
          <div class="text-xs text-gray-500 uppercase tracking-wide font-medium mb-1">Build L3</div>
          <div class="font-medium">Hardened Builds</div>
          <p class="text-sm text-gray-500">Provenance is generated by the platform via <code class="bg-gray-100 px-1 rounded text-xs">actions/attest-build-provenance</code>, outside the control of the build definition.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Sigstore -->
  <section class="mb-10">
    <h2 class="text-xl font-semibold mb-1">Sigstore &mdash; Artifact Signing</h2>
    <p class="text-sm text-gray-500 mb-4">
      <a href="https://docs.sigstore.dev/" class="underline hover:text-gray-700">Sigstore</a> &middot;
      <a href="https://docs.sigstore.dev/cosign/signing/signing_with_containers/" class="underline hover:text-gray-700">Cosign</a> &middot;
      <a href="https://docs.sigstore.dev/logging/overview/" class="underline hover:text-gray-700">Rekor</a>
    </p>
    <div class="bg-gray-50 rounded-lg p-6 space-y-4">
      <div class="grid sm:grid-cols-2 gap-6">
        <div>
          <div class="font-medium mb-1">Keyless Signing</div>
          <p class="text-sm text-gray-500">
            All patched container images and Helm chart OCI packages are signed using
            cosign with keyless OIDC. The GitHub Actions workflow identity token is used
            as the signing identity via Fulcio &mdash; no long-lived keys to manage or rotate.
          </p>
        </div>
        <div>
          <div class="font-medium mb-1">Transparency Log</div>
          <p class="text-sm text-gray-500">
            Every signature is recorded in the Rekor transparency log, providing a
            tamper-evident, publicly auditable record of all signing events.
            Signatures are tied to the specific GitHub Actions workflow run that produced the artifact.
          </p>
        </div>
      </div>
      <div>
        <div class="font-medium mb-1">Signing Identity</div>
        <p class="text-sm text-gray-500 mb-2">
          Signatures can be verified against the GitHub Actions OIDC issuer and the Verity repository identity:
        </p>
        <div class="bg-white border border-gray-200 rounded-lg p-3 font-mono text-xs break-all text-gray-700">
          <div>Issuer: <span class="text-gray-900">https://token.actions.githubusercontent.com</span></div>
          <div>Identity: <span class="text-gray-900">https://github.com/descope/verity/</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- SBOM -->
  <section class="mb-10">
    <h2 class="text-xl font-semibold mb-1">Software Bill of Materials</h2>
    <p class="text-sm text-gray-500 mb-4">
      <a href="https://cyclonedx.org/specification/overview/" class="underline hover:text-gray-700">CycloneDX Specification</a> &middot;
      <a href="https://www.ntia.gov/page/software-bill-of-materials" class="underline hover:text-gray-700">NTIA SBOM</a>
    </p>
    <div class="bg-gray-50 rounded-lg p-6">
      <p class="text-sm text-gray-500 mb-3">
        Every patched container image has a CycloneDX SBOM generated by
        <a href="https://trivy.dev/" class="underline hover:text-gray-700">Trivy</a>
        and attached as an in-toto attestation via <code class="bg-gray-100 px-1 rounded text-xs">actions/attest-sbom</code>.
        SBOMs enumerate all OS packages, libraries, and their versions, enabling downstream consumers to
        assess transitive risk independently.
      </p>
      <p class="text-sm text-gray-500">
        SBOM attestations are stored both in the GitHub attestation store and pushed directly
        to the OCI registry alongside the image, so they travel with the artifact.
      </p>
    </div>
  </section>

  <!-- Dependency management -->
  <section class="mb-10">
    <h2 class="text-xl font-semibold mb-1">Dependency Management</h2>
    <p class="text-sm text-gray-500 mb-4">
      <a href="https://bestpractices.openssf.org/Secure-Software-Development-Fundamentals/en/" class="underline hover:text-gray-700">OpenSSF Best Practices</a>
    </p>
    <div class="bg-gray-50 rounded-lg p-6">
      <div class="grid sm:grid-cols-2 gap-6">
        <div>
          <div class="font-medium mb-1">Pinned Dependencies</div>
          <p class="text-sm text-gray-500">
            Go modules are pinned with cryptographic hashes in <code class="bg-gray-100 px-1 rounded text-xs">go.sum</code>.
            GitHub Actions are pinned by full commit SHA, not floating tags. Helm chart
            dependencies use explicit versions.
          </p>
        </div>
        <div>
          <div class="font-medium mb-1">Automated Updates</div>
          <p class="text-sm text-gray-500">
            <a href="https://docs.renovatebot.com/" class="underline hover:text-gray-700">Renovate</a> continuously monitors
            for dependency updates. Security patches are auto-merged for Go minor/patch updates
            and GitHub Actions patch updates, keeping the supply chain current.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Vulnerability scanning -->
  <section class="mb-10">
    <h2 class="text-xl font-semibold mb-1">Continuous Vulnerability Scanning</h2>
    <p class="text-sm text-gray-500 mb-4">
      <a href="https://aquasecurity.github.io/trivy/" class="underline hover:text-gray-700">Trivy</a> &middot;
      <a href="https://github.com/project-copacetic/copacetic" class="underline hover:text-gray-700">Project Copacetic (Copa)</a>
    </p>
    <div class="bg-gray-50 rounded-lg p-6">
      <div class="grid sm:grid-cols-3 gap-4">
        <div>
          <div class="font-medium mb-1">Daily Scans</div>
          <p class="text-sm text-gray-500">A scheduled workflow runs every day at 02:00 UTC, re-scanning all images for newly disclosed vulnerabilities.</p>
        </div>
        <div>
          <div class="font-medium mb-1">Automatic Patching</div>
          <p class="text-sm text-gray-500">Copa patches fixable OS-level vulnerabilities in-place without rebuilding images, then signs and attests the result.</p>
        </div>
        <div>
          <div class="font-medium mb-1">PR-driven Updates</div>
          <p class="text-sm text-gray-500">When new vulnerabilities are found, a pull request is created automatically with updated patched images for review.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Framework mapping -->
  <section class="mb-10">
    <h2 class="text-xl font-semibold mb-4">Framework Reference</h2>
    <div class="overflow-x-auto">
      <table class="w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
        <thead class="bg-gray-50 text-left">
          <tr>
            <th class="px-4 py-3 font-medium text-gray-700">Framework</th>
            <th class="px-4 py-3 font-medium text-gray-700">Requirement</th>
            <th class="px-4 py-3 font-medium text-gray-700">How Verity Meets It</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <tr>
            <td class="px-4 py-3 font-medium whitespace-nowrap">
              <a href="https://slsa.dev/" class="underline hover:text-gray-700">SLSA v1.0</a>
            </td>
            <td class="px-4 py-3 text-gray-500">Build L3 provenance</td>
            <td class="px-4 py-3 text-gray-500">Platform-generated provenance via <code class="bg-gray-100 px-1 rounded text-xs">actions/attest-build-provenance</code> on GitHub-hosted runners</td>
          </tr>
          <tr>
            <td class="px-4 py-3 font-medium whitespace-nowrap">
              <a href="https://www.nist.gov/system/files/documents/2022/02/04/software-supply-chain-security-guidance-under-EO-14028-section-4e.pdf" class="underline hover:text-gray-700">EO 14028</a>
            </td>
            <td class="px-4 py-3 text-gray-500">SBOM for delivered software</td>
            <td class="px-4 py-3 text-gray-500">CycloneDX SBOM attested to every container image</td>
          </tr>
          <tr>
            <td class="px-4 py-3 font-medium whitespace-nowrap">
              <a href="https://csrc.nist.gov/Projects/ssdf" class="underline hover:text-gray-700">NIST SSDF</a>
            </td>
            <td class="px-4 py-3 text-gray-500">PS.1 &mdash; Protect software integrity</td>
            <td class="px-4 py-3 text-gray-500">Cryptographic signing of all artifacts with Sigstore keyless OIDC; transparency log</td>
          </tr>
          <tr>
            <td class="px-4 py-3 font-medium whitespace-nowrap">
              <a href="https://csrc.nist.gov/Projects/ssdf" class="underline hover:text-gray-700">NIST SSDF</a>
            </td>
            <td class="px-4 py-3 text-gray-500">PW.4 &mdash; Verify third-party components</td>
            <td class="px-4 py-3 text-gray-500">Continuous Trivy scanning of all upstream images; automated Copa patching</td>
          </tr>
          <tr>
            <td class="px-4 py-3 font-medium whitespace-nowrap">
              <a href="https://csrc.nist.gov/Projects/ssdf" class="underline hover:text-gray-700">NIST SSDF</a>
            </td>
            <td class="px-4 py-3 text-gray-500">RV.1 &mdash; Identify and confirm vulnerabilities</td>
            <td class="px-4 py-3 text-gray-500">Daily scheduled scans; auto-generated PRs for new vulnerabilities</td>
          </tr>
          <tr>
            <td class="px-4 py-3 font-medium whitespace-nowrap">
              <a href="https://bestpractices.openssf.org/" class="underline hover:text-gray-700">OpenSSF Scorecard</a>
            </td>
            <td class="px-4 py-3 text-gray-500">Pinned-Dependencies</td>
            <td class="px-4 py-3 text-gray-500">All Actions pinned by SHA; Go deps pinned via go.sum; Renovate auto-updates</td>
          </tr>
          <tr>
            <td class="px-4 py-3 font-medium whitespace-nowrap">
              <a href="https://bestpractices.openssf.org/" class="underline hover:text-gray-700">OpenSSF Scorecard</a>
            </td>
            <td class="px-4 py-3 text-gray-500">Signed-Releases</td>
            <td class="px-4 py-3 text-gray-500">All published OCI artifacts signed with cosign keyless</td>
          </tr>
          <tr>
            <td class="px-4 py-3 font-medium whitespace-nowrap">
              <a href="https://docs.sigstore.dev/" class="underline hover:text-gray-700">Sigstore</a>
            </td>
            <td class="px-4 py-3 text-gray-500">Artifact transparency</td>
            <td class="px-4 py-3 text-gray-500">All signatures recorded in the Rekor transparency log; verifiable by anyone</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Verification -->
  <section class="mb-10">
    <h2 class="text-xl font-semibold mb-4">Verify It Yourself</h2>
    <p class="text-sm text-gray-500 mb-4">
      You don't have to trust us &mdash; verify signatures and attestations directly.
    </p>
    <div class="space-y-4">
      <div>
        <div class="text-sm font-medium mb-2">Verify cosign signature on an image</div>
        <div class="bg-gray-900 text-gray-100 rounded-lg p-4 font-mono text-sm overflow-x-auto flex items-start justify-between gap-4">
          <pre class="whitespace-pre-wrap break-all">cosign verify \
  --certificate-identity-regexp "https://github.com/descope/verity/" \
  --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
  ghcr.io/descope/grafana/grafana:11.6.0-patched</pre>
          <CopyButton text='cosign verify --certificate-identity-regexp "https://github.com/descope/verity/" --certificate-oidc-issuer "https://token.actions.githubusercontent.com" ghcr.io/descope/grafana/grafana:11.6.0-patched' />
        </div>
      </div>
      <div>
        <div class="text-sm font-medium mb-2">Verify GitHub build provenance attestation</div>
        <div class="bg-gray-900 text-gray-100 rounded-lg p-4 font-mono text-sm overflow-x-auto flex items-start justify-between gap-4">
          <pre class="whitespace-pre-wrap break-all">gh attestation verify \
  oci://ghcr.io/descope/grafana/grafana:11.6.0-patched \
  --owner descope</pre>
          <CopyButton text='gh attestation verify oci://ghcr.io/descope/grafana/grafana:11.6.0-patched --owner descope' />
        </div>
      </div>
      <div>
        <div class="text-sm font-medium mb-2">Verify cosign signature on a Helm chart</div>
        <div class="bg-gray-900 text-gray-100 rounded-lg p-4 font-mono text-sm overflow-x-auto flex items-start justify-between gap-4">
          <pre class="whitespace-pre-wrap break-all">cosign verify \
  --certificate-identity-regexp "https://github.com/descope/verity/" \
  --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
  ghcr.io/descope/charts/prometheus:28.9.1-5</pre>
          <CopyButton text='cosign verify --certificate-identity-regexp "https://github.com/descope/verity/" --certificate-oidc-issuer "https://token.actions.githubusercontent.com" ghcr.io/descope/charts/prometheus:28.9.1-5' />
        </div>
      </div>
    </div>
  </section>

  <!-- Pipeline overview -->
  <section>
    <h2 class="text-xl font-semibold mb-4">Build Pipeline Overview</h2>
    <div class="bg-gray-50 rounded-lg p-6">
      <ol class="space-y-3 text-sm text-gray-600 list-decimal list-inside">
        <li><span class="font-medium text-gray-900">Discover</span> &mdash; Helm chart dependencies and standalone images are enumerated from version-controlled manifests</li>
        <li><span class="font-medium text-gray-900">Scan</span> &mdash; Trivy scans each image for OS-level vulnerabilities with fixable-only filtering</li>
        <li><span class="font-medium text-gray-900">Patch</span> &mdash; Copa patches fixable CVEs in-place on parallel ephemeral GitHub Actions runners</li>
        <li><span class="font-medium text-gray-900">Push</span> &mdash; Patched images are pushed to the GHCR OCI registry</li>
        <li><span class="font-medium text-gray-900">Sign</span> &mdash; Cosign signs each artifact using keyless OIDC; signatures are logged in Rekor</li>
        <li><span class="font-medium text-gray-900">Attest</span> &mdash; SLSA build provenance and CycloneDX SBOM are attached as in-toto attestations</li>
        <li><span class="font-medium text-gray-900">Publish</span> &mdash; Wrapper Helm charts are packaged, pushed, and signed in the OCI registry</li>
      </ol>
    </div>
  </section>
</BaseLayout>
