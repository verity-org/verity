# Wrapper Charts

Verity automatically generates wrapper Helm charts for each dependency that contains patched images.
These wrapper charts make it easy to deploy upstream charts with security-patched container images.

## Architecture

```text
Chart.yaml        # Meta-chart with all upstream dependencies
values.yaml       # Centralized image list (auto-generated by scan)
Chart.lock        # Locked dependency versions
charts/*.tgz      # Downloaded chart dependencies (gitignored)
dist/
  charts/         # Generated wrapper charts (one per dependency)
    prometheus/
      Chart.yaml  # Wrapper with upstream chart as dependency
      values.yaml # Overrides with patched image refs
    grafana/
      Chart.yaml
      values.yaml
```

## Benefits

✅ **Automated** - Renovate updates Chart.yaml → scan updates values.yaml → assemble generates wrappers
✅ **Easy deployment** - Users install from OCI registry with patched images pre-configured
✅ **Version tracking** - Wrapper versions track upstream + patch level (e.g., 28.9.1-0, 28.9.1-1)
✅ **Supply chain transparency** - Each chart published with SBOM and provenance attestations

## How It Works

### 1. Discovery

```bash
# Renovate updates Chart.yaml with new chart versions
# Run scan to discover all images from dependencies
verity scan --chart . --output values.yaml
```

This extracts all container images from Chart.yaml dependencies and writes them to values.yaml.

### 2. Patching

The GitHub Actions workflow:

1. Runs `verity discover` to parse values.yaml and generate a patch matrix
2. Patches each image in parallel using Copa
3. Pushes patched images to the registry (e.g., ghcr.io/verity-org)

### 3. Assembly

```bash
# Generate wrapper charts for changed images
verity assemble \
  --manifest discovery.json \
  --results-dir results/ \
  --registry ghcr.io/verity-org \
  --output dist/charts/
```

This creates a wrapper chart for each upstream chart that has patched images:

- Adds the upstream chart as a dependency
- Generates values.yaml with patched image references
- Increments patch version if images changed (e.g., 28.9.1-0 → 28.9.1-1)
- Skips charts where no images changed

### 4. Publishing

```bash
# Publish wrapper charts to OCI registry
verity catalog \
  --images values.yaml \
  --registry ghcr.io/verity-org \
  --output dist/published-charts.json
```

Charts are pushed to `ghcr.io/verity-org/charts/<name>:<version>`.

## Using Wrapper Charts

### Install from OCI Registry

```bash
# Install wrapper chart with patched images pre-configured
helm install prometheus oci://ghcr.io/verity-org/charts/prometheus --version 28.9.1-0

# List available charts
helm search repo oci://ghcr.io/verity-org/charts/
```

The wrapper chart automatically uses security-patched images from ghcr.io/verity-org.

### Version Format

Wrapper chart versions follow: `<upstream-version>-<patch-level>`

- **28.9.1-0** - First release for upstream version 28.9.1
- **28.9.1-1** - Updated patch (new image vulnerabilities fixed)
- **28.9.2-0** - New upstream version

### Viewing Charts

Browse available charts and their patched images at:

- **Homepage**: Lists all charts with vulnerability counts
- **Chart page**: `/charts/<name>/` - All versions
- **Version page**: `/charts/<name>/<version>/` - Image details and Helm install command

## Alternative: Direct Image Usage

You can also use upstream charts with our patched images:

```yaml
# values.yaml
prometheus:
  server:
    image:
      registry: ghcr.io/verity-org
      repository: prometheus/prometheus
      tag: v2.45.0-patched
```

```bash
helm install prometheus prometheus-community/prometheus -f values.yaml
```

## Benefits of Wrapper Charts

**For users:**

- ✅ One command to install with patched images
- ✅ No manual values.yaml configuration needed
- ✅ Automatic updates via Renovate/Dependabot

**For maintainers:**

- ✅ Automated generation from patch results
- ✅ Version tracking with patch levels
- ✅ Supply chain attestations (SBOM, provenance)
- ✅ Catalog website auto-generated from published charts
