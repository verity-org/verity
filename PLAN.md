# Plan: Unify Image Handling

## Overview

Break the barrier between standalone images and chart images. The primary product is a **registry of patched images**. Charts are a secondary, assembled artifact. `values.yaml` becomes the single source of truth for all images. Vulnerability reports move from chart-bundled/centralized storage to in-toto attestations on each image.

## Current Architecture

- **Discover**: Reads `Chart.yaml` (charts) + `values.yaml` (standalone) → `manifest.json` with separate `Charts[]` and `Standalone[]` sections + `matrix.json`
- **Patch**: Each matrix job patches one image → writes `SinglePatchResult` + Trivy report
- **Assemble**: Reads manifest + results → creates wrapper charts (with embedded reports, `paths.json`, `overrides.json`) + pushes `standalone-reports:latest` OCI artifact
- **Site data**: Reads from chart packages (reports embedded) + pulls standalone-reports from OCI

## New Architecture

- **Discover**: Reads `Chart.yaml` → downloads charts → finds images → **merges them into `values.yaml`** alongside existing manually-maintained images. Still writes `manifest.json` (chart→images grouping needed by assemble) + `matrix.json` (from full `values.yaml`).
- **Patch**: Same as today — each matrix job patches one image. Additionally, Trivy report is attached as **in-toto attestation** on the patched image (workflow change).
- **Assemble**: Reads manifest + results → creates wrapper charts (image overrides only, **no bundled reports**). Generates site data from unified image list.
- **Site data**: All images are unified. Reports come from local build artifacts (not chart packages or standalone-reports OCI). No more `StandaloneImages` — everything is an image, optionally associated with a chart.

---

## Implementation Steps

### Step 1: Add image merging to values.yaml (`scanner.go`)

Add functions to merge discovered chart images into the existing values.yaml:

- `MergeImagesIntoFile(path string, discovered []Image) error` — reads existing values.yaml, identifies which images are already present (by reference match), adds new ones, writes back. Preserves the `overrides:` section and manually-maintained entries.
- Uses a `# chart-discovered` YAML comment marker on auto-generated entries so they can be identified and refreshed on subsequent runs.

**Alternative (simpler)**: Instead of inline comments, track chart-discovered images separately. The discover step writes a `chart-images:` top-level section in values.yaml that is fully regenerated each run. Manually-maintained images live outside this section.

**Chosen approach**: Use a `chart-images:` section in values.yaml. The discover step replaces this section entirely on each run. Manually-maintained images stay in the top-level. `ParseImagesFile()` reads from both sections.

New values.yaml structure:
```yaml
overrides:
  timberio/vector:
    from: "distroless-libc"
    to: "debian"

# Manually maintained standalone images
redis-exporter:
  image:
    registry: quay.io
    repository: opstree/redis-exporter
    tag: "v1.80.2"
# ... etc

# Images discovered from charts (auto-generated by verity discover)
chart-images:
  prometheus-server:
    image:
      registry: quay.io
      repository: prometheus/prometheus
      tag: "v3.9.1"
  prometheus-alertmanager:
    image:
      registry: quay.io
      repository: prometheus/alertmanager
      tag: "v0.31.0"
  # ... etc
```

Files changed:
- `internal/scanner.go`: Add `MergeChartImages(valuesPath string, chartImages []Image) error`, update `ParseImagesFile()` to also read from `chart-images:` section
- `internal/scanner_test.go`: Tests for merge and parse of new format

### Step 2: Update discover to write chart images (`matrix.go`, `main.go`)

Modify `DiscoverImages()` to call `MergeChartImages()` after discovering chart images.

Changes:
- `internal/matrix.go`: `DiscoverImages()` gets a new parameter (or the values file path is passed in) so it can write discovered chart images back to values.yaml
- `main.go`: `runDiscover()` passes the images file path to `DiscoverImages()` for writing
- The manifest.json still tracks chart→images grouping (needed by assemble)
- The `Standalone` section of the manifest is removed — all images come from values.yaml

**Manifest simplification**: `DiscoveryManifest` keeps `Charts[]` (for assemble) but no longer has `Standalone[]`. Instead, add an `Images[]` field that lists ALL images (from values.yaml). The matrix is generated from `Images[]`.

```go
type DiscoveryManifest struct {
    Charts []ChartDiscovery `json:"charts"`
    Images []ImageDiscovery `json:"images"` // All images from values.yaml
}
```

Files changed:
- `internal/matrix.go`: Update `DiscoverImages()`, `GenerateMatrix()`, `DiscoveryManifest` struct
- `main.go`: Update `runDiscover()`, `applyOverridesToManifest()`
- `internal/matrix_test.go`: Update tests

### Step 3: Update assemble to work with unified images (`matrix.go`, `values.go`)

Assemble no longer bundles reports. It creates wrapper charts with image overrides only.

Changes:
- `internal/matrix.go`: `AssembleResults()` no longer calls `SaveStandaloneReports()`. It builds patch results from `manifest.Images` instead of separate chart/standalone handling.
- `internal/values.go`: `CreateWrapperChart()` no longer copies Trivy reports to `reports/` directory. Remove report-copying logic.
- Keep `paths.json` and `overrides.json` generation (still needed for site data).

Files changed:
- `internal/matrix.go`: Simplify `AssembleResults()`
- `internal/values.go`: Remove report copying from `CreateWrapperChart()`
- `internal/values_test.go`: Update `TestCreateWrapperChart()`
- `internal/matrix_test.go`: Update `TestAssembleResults()`

### Step 4: Update site data for unified images (`sitedata.go`)

Remove standalone/chart distinction from site data. All images are just images.

Changes:
- `SiteData`: Remove `StandaloneImages` field. All images either belong to a chart or are standalone (but both are in the same `Images` list or the charts' image lists).
- `SiteSummary`: Update to work with unified data.
- `discoverStandaloneImages()`: Remove (no longer needed separately).
- `pullStandaloneReports()` / `PushStandaloneReports()`: Remove.
- `GenerateSiteData()`: Read all images from values.yaml. Match to chart groupings from local chart dirs. Reports come from local reports dir (available during build).
- `parseWrapperChart()`: No longer expects `reports/` directory in chart packages.

Actually, site data generation needs re-thinking. Currently it pulls reports from OCI. In the new model, reports are in-toto attestations. During CI, the reports are available as build artifacts. The site data can be generated from those.

**Approach**: Site data is generated during the assemble job where reports are available as artifacts. It reads values.yaml for the full image list and matches to available reports. For historical versions, we could pull attestations... but that's complex.

**Simpler approach**: Site data only shows the current version (not historical). Reports are available locally during CI. The site shows all images from values.yaml with their vulnerability data.

Files changed:
- `internal/sitedata.go`: Major refactor — unified image handling, remove standalone-reports OCI logic
- `internal/sitedata_test.go`: Update tests

### Step 5: Remove standalone-reports mode (`main.go`)

- Remove `-push-standalone-reports` flag and `runPushStandaloneReports()` function
- Remove `PushStandaloneReports()` and `pullStandaloneReports()` from `sitedata.go`

Files changed:
- `main.go`: Remove mode
- `internal/sitedata.go`: Remove functions

### Step 6: Update GitHub Actions workflow

Changes to `.github/workflows/scan-and-patch.yaml`:

**Patch job**:
- After scanning, attach Trivy report as in-toto attestation on the patched image:
  ```yaml
  - name: Attest vulnerability report
    if: steps.digest.outputs.has_image == 'true'
    uses: actions/attest@v3
    with:
      subject-name: ${{ steps.digest.outputs.image }}
      subject-digest: ${{ steps.digest.outputs.digest }}
      predicate-type: https://cosign.sigstore.dev/attestation/vuln/v1
      predicate-path: .verity/reports/${{ matrix.image_name }}.json
      push-to-registry: true
  ```

**Discover job**:
- Now writes updated values.yaml (commit back to PR branch or make available as artifact)

**Assemble job**:
- Remove standalone-reports push step
- Remove standalone-reports repo publicity step
- Site data generation uses local reports from artifacts

Files changed:
- `.github/workflows/scan-and-patch.yaml`

### Step 7: Update tests and ensure compatibility

- Run all existing tests, fix any that break
- Add new tests for:
  - `MergeChartImages()`: merging chart images into values.yaml
  - `ParseImagesFile()`: reading from `chart-images:` section
  - Updated manifest structure
  - Assemble without reports bundling
  - Site data from unified source

---

## Migration Notes

- The `chart-images:` section in values.yaml will be auto-generated on first discover run
- Existing manually-maintained standalone images are preserved
- Chart packages in the registry will no longer contain `reports/` directories
- Historical chart versions in the registry still have embedded reports (backward compatible)
- The standalone-reports OCI artifact is no longer pushed (can be cleaned up manually)

## Files Changed Summary

| File | Changes |
|------|---------|
| `internal/scanner.go` | Add `MergeChartImages()`, update `ParseImagesFile()` |
| `internal/scanner_test.go` | Tests for new functions |
| `internal/matrix.go` | Update `DiscoveryManifest`, `DiscoverImages()`, `GenerateMatrix()`, `AssembleResults()` |
| `internal/matrix_test.go` | Update tests |
| `internal/values.go` | Remove report copying from `CreateWrapperChart()` |
| `internal/values_test.go` | Update tests |
| `internal/sitedata.go` | Remove standalone/chart distinction, remove OCI report storage |
| `internal/sitedata_test.go` | Update tests |
| `main.go` | Update discover flow, remove `push-standalone-reports` |
| `values.yaml` | New `chart-images:` section (auto-generated) |
| `.github/workflows/scan-and-patch.yaml` | Add attestation, remove standalone reports, update discover |
