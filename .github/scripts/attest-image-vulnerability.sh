#!/bin/bash
# Attest vulnerability report for container image
set -euo pipefail

IMAGE="$1"
DIGEST="$2"
REPORTS_DIR="${3:-.verity/reports}"
TOKEN="${4:-}"

if [ -n "$TOKEN" ]; then
  echo "$TOKEN" | cosign login ghcr.io -u "${GITHUB_ACTOR:-github-actions}" --password-stdin
fi

report=$(find "$REPORTS_DIR" -name '*.json' -print -quit 2>/dev/null)
if [ -n "$report" ]; then
  cosign attest --yes --type vuln \
    --predicate "$report" \
    "${IMAGE}@${DIGEST}"
  echo "✓ Attested vulnerability report for ${IMAGE}@${DIGEST}"
else
  echo "⚠ No vulnerability report found in $REPORTS_DIR"
fi
