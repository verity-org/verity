#!/bin/bash
# Attest vulnerability report for Helm chart
set -euo pipefail

OCI_NAME="$1"
DIGEST="$2"
CHART_NAME="$3"
CHARTS_DIR="${4:-.verity/charts}"
TOKEN="${5:-}"

if [ -n "$TOKEN" ]; then
  echo "$TOKEN" | cosign login ghcr.io -u "$(echo "$GITHUB_ACTOR" || echo "github-actions")" --password-stdin
fi

vuln_predicate="$CHARTS_DIR/$CHART_NAME/vuln-predicate.json"
if [ -f "$vuln_predicate" ]; then
  cosign attest --yes --type vuln \
    --predicate "$vuln_predicate" \
    "${OCI_NAME}@${DIGEST}"
  echo "✓ Attested vulnerability report for chart ${OCI_NAME}@${DIGEST}"
else
  echo "⚠ No vulnerability predicate found: $vuln_predicate"
fi
