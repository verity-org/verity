name: Scan and Patch Charts

on:
  # Validate PRs (Renovate, new-issue workflow, manual chart updates)
  pull_request:
    branches: [main]
    paths:
      - 'Chart.yaml'
      - 'values.yaml'

  # Publish when PRs merge to main (all sources)
  push:
    branches: [main]
    paths:
      - 'Chart.yaml'
      - 'values.yaml'

  # Daily vulnerability scan
  schedule:
    - cron: '0 2 * * *'

  # Manual trigger
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pull-requests: write
  id-token: write
  attestations: write

env:
  REGISTRY: quay.io/verity

jobs:
  # ── Job 1: Discover images ─────────────────────────────────────────
  discover:
    name: Discover Images
    runs-on: ubuntu-latest
    # For PRs, only run if from same repo (security: prevent fork PRs from accessing secrets)
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    outputs:
      matrix: ${{ steps.discover.outputs.matrix }}
      has_images: ${{ steps.discover.outputs.has_images }}
    steps:
      - uses: actions/checkout@v6
        with:
          # For PRs, check out the PR branch; otherwise use the pushed ref
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Login to Quay.io (Helm)
        run: echo "${{ secrets.QUAY_PASSWORD }}" | helm registry login quay.io --username "${{ secrets.QUAY_USERNAME }}" --password-stdin

      - name: Build verity
        run: go build -o verity .

      - name: Discover images
        id: discover
        run: |
          ./verity -discover \
            -chart Chart.yaml \
            -images values.yaml \
            -discover-dir .verity

          matrix=$(cat .verity/matrix.json)
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

          count=$(echo "$matrix" | jq '.include | length')
          if [ "$count" -gt 0 ]; then
            echo "has_images=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_images=false" >> "$GITHUB_OUTPUT"
          fi

          echo "Found $count unique images to patch"

      - name: Upload manifest
        uses: actions/upload-artifact@v6
        with:
          name: verity-manifest
          path: .verity/manifest.json
          retention-days: 1

  # ── Job 2: Patch each image in parallel ────────────────────────────
  patch:
    name: "Patch ${{ matrix.image_name }}"
    needs: discover
    if: needs.discover.outputs.has_images == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
      fail-fast: true  # Fail entire workflow if ANY image fails to patch
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Login to Quay.io (Docker)
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build verity
        run: go build -o verity .

      - name: Set up Trivy
        uses: aquasecurity/setup-trivy@3fb12ec12f41e471780db15c232d5dd185dcb514 # v0.2.5
        with:
          version: latest
          cache: true

      - name: Install Copa
        run: ./.github/scripts/install-copa.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Patch image
        run: |
          ./verity -patch-single \
            -image "${{ matrix.image_ref }}" \
            -registry "$REGISTRY" \
            -buildkit-addr "docker-container://buildx_buildkit_${{ steps.buildx.outputs.name }}0" \
            -report-dir .verity/reports \
            -result-dir .verity/results

      - name: Ensure Quay.io repo is public
        if: always()
        env:
          QUAY_API_TOKEN: ${{ secrets.QUAY_API_TOKEN }}
        run: |
          result_file=$(find .verity/results -name '*.json' -print -quit 2>/dev/null)
          [ -z "$result_file" ] && exit 0
          repo=$(jq -r '.patched_repository // empty' "$result_file")
          [ -z "$repo" ] && exit 0
          ./.github/scripts/quay-make-public.sh verity "$repo" || true

      - name: Install cosign
        uses: sigstore/cosign-installer@398d4b0eeef1380460a10c8013a76f728fb906ac # v3

      - name: Install crane
        run: go install github.com/google/go-containerregistry/cmd/crane@latest

      - name: Get patched image digest
        id: digest
        run: |
          result_file=$(find .verity/results -name '*.json' -print -quit 2>/dev/null)
          if [ -z "$result_file" ]; then
            echo "has_image=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          registry=$(jq -r '.patched_registry // empty' "$result_file")
          repo=$(jq -r '.patched_repository // empty' "$result_file")
          tag=$(jq -r '.patched_tag // empty' "$result_file")
          skipped=$(jq -r '.skipped' "$result_file")
          err=$(jq -r '.error // empty' "$result_file")

          if [ -z "$registry" ] || [ -z "$repo" ] || [ -z "$tag" ]; then
            echo "has_image=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ -n "$err" ]; then
            echo "has_image=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          image="${registry}/${repo}"
          image_with_tag="${image}:${tag}"
          digest=$(crane digest "$image_with_tag")
          echo "image=${image}" >> "$GITHUB_OUTPUT"
          echo "image_with_tag=${image_with_tag}" >> "$GITHUB_OUTPUT"
          echo "digest=${digest}" >> "$GITHUB_OUTPUT"
          echo "has_image=true" >> "$GITHUB_OUTPUT"
          echo "Resolved ${image_with_tag} → ${digest}"

      - name: Sign image with cosign
        if: steps.digest.outputs.has_image == 'true'
        env:
          QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
          QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
        run: |
          cosign login quay.io -u "$QUAY_USERNAME" -p "$QUAY_PASSWORD"
          cosign sign --yes "${{ steps.digest.outputs.image }}@${{ steps.digest.outputs.digest }}"

      - name: Attest build provenance
        if: steps.digest.outputs.has_image == 'true'
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ steps.digest.outputs.image }}
          subject-digest: ${{ steps.digest.outputs.digest }}
          push-to-registry: true

      - name: Generate SBOM
        if: steps.digest.outputs.has_image == 'true'
        run: |
          trivy image --format cyclonedx --output .verity/sbom.cdx.json \
            "${{ steps.digest.outputs.image }}@${{ steps.digest.outputs.digest }}"

      - name: Attest SBOM
        if: steps.digest.outputs.has_image == 'true'
        uses: actions/attest-sbom@v2
        with:
          subject-name: ${{ steps.digest.outputs.image }}
          subject-digest: ${{ steps.digest.outputs.digest }}
          sbom-path: .verity/sbom.cdx.json
          push-to-registry: true

      - name: Upload patch result
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: "patch-result-${{ matrix.image_name }}"
          path: |
            .verity/results/*.json
            .verity/reports/*.json
          retention-days: 1

  # ── Job 3: Assemble wrapper charts ─────────────────────────────────
  assemble:
    name: Assemble Wrapper Charts
    needs: [discover, patch]
    # Only run if ALL patch jobs succeeded - prevents data loss from failed patches
    if: needs.discover.outputs.has_images == 'true' && needs.patch.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Login to Quay.io (Docker)
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Login to Quay.io (Helm)
        run: echo "${{ secrets.QUAY_PASSWORD }}" | helm registry login quay.io --username "${{ secrets.QUAY_USERNAME }}" --password-stdin

      - name: Build verity
        run: go build -o verity .

      - name: Download manifest
        uses: actions/download-artifact@v6
        with:
          name: verity-manifest
          path: .verity

      - name: Download all patch results
        uses: actions/download-artifact@v6
        with:
          pattern: "patch-result-*"
          path: .verity/artifacts
          merge-multiple: false

      - name: Collect results and reports
        run: |
          mkdir -p .verity/results .verity/reports

          for artifact_dir in .verity/artifacts/patch-result-*; do
            [ -d "$artifact_dir" ] || continue
            find "$artifact_dir" -name '*.json' -path '*/results/*' -exec cp -n {} .verity/results/ \; 2>/dev/null || true
            find "$artifact_dir" -name '*.json' -path '*/reports/*' -exec cp -n {} .verity/reports/ \; 2>/dev/null || true
          done

          echo "Results: $(ls .verity/results/ 2>/dev/null | wc -l) files"
          echo "Reports: $(ls .verity/reports/ 2>/dev/null | wc -l) files"

      - name: Assemble wrapper charts
        run: |
          ./verity -assemble \
            -manifest .verity/manifest.json \
            -results-dir .verity/results \
            -reports-dir .verity/reports \
            -output charts \
            -registry "$REGISTRY" \
            -images values.yaml

      # ═══════════════════════════════════════════════════════════════
      # Branch 1: Pull Request Flow (Renovate, new-issue, manual PRs)
      # ═══════════════════════════════════════════════════════════════
      - name: Commit changes to PR branch
        if: github.event_name == 'pull_request'
        run: ./.github/scripts/commit-changes.sh charts

      # ═══════════════════════════════════════════════════════════════
      # Branch 2: Push/Schedule Flow (Publish to OCI)
      # ═══════════════════════════════════════════════════════════════
      - name: Check for changes
        if: github.event_name != 'pull_request'
        id: check-changes
        run: ./.github/scripts/check-chart-changes.sh

      - name: Publish wrapper charts to OCI
        if: github.event_name != 'pull_request' && steps.check-changes.outputs.changes == 'true'
        env:
          QUAY_API_TOKEN: ${{ secrets.QUAY_API_TOKEN }}
        run: ./.github/scripts/publish-charts.sh . quay.io verity

      # NEW: Sign charts immediately after publishing (atomic operation)
      - name: Install cosign
        if: github.event_name != 'pull_request' && steps.check-changes.outputs.changes == 'true'
        uses: sigstore/cosign-installer@398d4b0eeef1380460a10c8013a76f728fb906ac # v3

      - name: Install crane
        if: github.event_name != 'pull_request' && steps.check-changes.outputs.changes == 'true'
        uses: imjasonh/setup-crane@31b88efe9de28ae0ffa220711af4b60be9435f6e # v0.4

      - name: Sign published charts
        if: github.event_name != 'pull_request' && steps.check-changes.outputs.changes == 'true'
        run: ./.github/scripts/sign-charts.sh . quay.io verity

      - name: Push standalone reports to OCI
        if: github.event_name != 'pull_request' && steps.check-changes.outputs.changes == 'true'
        run: |
          ./verity -push-standalone-reports \
            -reports-dir reports \
            -registry "$REGISTRY"

      - name: Ensure standalone-reports repo is public
        if: github.event_name != 'pull_request' && steps.check-changes.outputs.changes == 'true'
        env:
          QUAY_API_TOKEN: ${{ secrets.QUAY_API_TOKEN }}
        run: ./.github/scripts/quay-make-public.sh verity standalone-reports || true

      # ═══════════════════════════════════════════════════════════════
      # Branch 3: Schedule Flow Only (Create PR for review)
      # ═══════════════════════════════════════════════════════════════
      - name: Create Pull Request
        if: github.event_name == 'schedule' && steps.check-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          commit-message: "chore: update patched images with latest security fixes"
          title: "Security: Update patched images"
          body: |
            ## Scheduled Vulnerability Scan

            This PR updates wrapper charts with newly discovered vulnerability patches.

            ### Changes
            - Re-scanned all charts for vulnerabilities
            - Applied Copa patches to fixable vulnerabilities via parallel matrix jobs
            - Updated wrapper chart images
            - Published charts and reports to OCI registry

            ### Reports
            Trivy vulnerability reports are stored in OCI at `${{ env.REGISTRY }}/standalone-reports:latest`
          branch: security/scheduled-patch-${{ github.run_number }}
          delete-branch: true
          labels: |
            security
            automated

      - name: Upload vulnerability reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: trivy-reports-${{ github.event_name }}
          path: .verity/reports/*.json
          retention-days: 30
