name: Patch and Publish Images

# This workflow supports two modes:
# 1. Production (main branch): Patches images, pushes to ghcr.io, signs with cosign, deploys site
# 2. PR Testing: Uses local registry, skips signing, validates pipeline without publishing

on:
  schedule:
    - cron: '0 2 * * *'
  push:
    branches: [main]
    paths: ['copa-config.yaml', '.github/workflows/scan-and-patch.yaml']
  pull_request:
    paths: ['copa-config.yaml', '.github/workflows/scan-and-patch.yaml', 'internal/**', 'cmd/**']
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  patch-and-publish:
    name: Patch, Sign & Publish
    runs-on: ubuntu-latest
    env:
      # Use local registry for PRs, production registry for main
      REGISTRY: ${{ github.event_name == 'pull_request' && 'localhost:5000/verity-test' || 'ghcr.io/verity-org' }}

    services:
      # Local registry for PR testing
      registry:
        image: registry:3
        ports:
          - 5000:5000
        options: >-
          --health-cmd "wget -q --spider http://localhost:5000/v2/ || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
        with:
          driver-opts: network=host
          buildkitd-flags: --allow-insecure-entitlement network.host
          buildkitd-config-inline: |
            [registry."localhost:5000"]
              http = true
              insecure = true

      - name: Login to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify local registry for PR testing
        if: github.event_name == 'pull_request'
        run: |
          # Wait for registry service to be healthy
          timeout 30 bash -c 'until curl -f http://localhost:5000/v2/; do sleep 1; done'
          echo "✓ Local registry ready at localhost:5000"

      - name: Get Copa fork branch and commit
        id: copa-info
        run: |
          # Try verity branch first, fallback to feat/bulk-skip-detection
          if gh api repos/verity-org/copacetic/commits/verity --jq .sha >/dev/null 2>&1; then
            BRANCH="verity"
            COMMIT=$(gh api repos/verity-org/copacetic/commits/verity --jq .sha)
          else
            BRANCH="feat/bulk-skip-detection"
            COMMIT=$(gh api repos/verity-org/copacetic/commits/feat/bulk-skip-detection --jq .sha)
          fi
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "hash=$COMMIT" >> "$GITHUB_OUTPUT"
          echo "Using Copa fork branch: $BRANCH (commit: $COMMIT)"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Cache Copa binary
        id: cache-copa
        uses: actions/cache@v4
        with:
          path: ~/go/bin/copa
          key: copa-${{ runner.os }}-${{ steps.copa-info.outputs.hash }}

      - name: Build Copa from fork
        if: steps.cache-copa.outputs.cache-hit != 'true'
        run: |
          echo "Building Copa from branch: ${{ steps.copa-info.outputs.branch }}"
          git clone --branch "${{ steps.copa-info.outputs.branch }}" --depth 1 \
            https://github.com/verity-org/copacetic.git /tmp/copa
          cd /tmp/copa && go build -o "$(go env GOPATH)/bin/copa" .
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Install tools
        run: |
          go install github.com/google/go-containerregistry/cmd/crane@latest
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Install yq
        run: |
          VERSION=$(curl -sL https://api.github.com/repos/mikefarah/yq/releases/latest | jq -r .tag_name)
          curl -sL "https://github.com/mikefarah/yq/releases/download/${VERSION}/yq_linux_amd64" -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Install cosign
        if: github.event_name != 'pull_request'
        uses: sigstore/cosign-installer@398d4b0eeef1380460a10c8013a76f728fb906ac # v3

      - name: Configure Copa registry for PR testing
        if: github.event_name == 'pull_request'
        run: |
          echo "Setting Copa target registry to $REGISTRY for PR testing"
          yq eval '.target.registry = env(REGISTRY)' -i copa-config.yaml
          echo "Copa config target registry:"
          yq eval '.target.registry' copa-config.yaml

      - name: Copa bulk patch
        run: |
          copa patch \
            --config copa-config.yaml \
            --push \
            --ignore-errors \
            --addr "docker-container://buildx_buildkit_${{ steps.buildx.outputs.name }}0" \
            --timeout 30m

      - name: Scan and sign patched images
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR mode: scan only, no signing
            ./.github/scripts/sign-and-attest.sh copa-config.yaml "$REGISTRY" .verity/reports .verity/images.json --skip-signing
          else
            # Production mode: full signing and attestation
            ./.github/scripts/sign-and-attest.sh copa-config.yaml "$REGISTRY" .verity/reports .verity/images.json
          fi

      - name: Validate patched images
        run: |
          if [ ! -s .verity/images.json ]; then
            echo "Error: No images were successfully patched (.verity/images.json is missing or empty)."
            echo "This may indicate Copa failed to patch all images, or no images matched the config."
            echo "Check the Copa patch logs above for errors."
            exit 1
          fi
          IMAGE_COUNT=$(jq length .verity/images.json)
          echo "✓ Successfully patched $IMAGE_COUNT image(s)"

      - name: Build verity
        run: go build -o verity .

      - name: Generate catalog
        run: |
          ./verity catalog \
            --images-json .verity/images.json \
            --reports-dir .verity/reports \
            --registry "$REGISTRY" \
            --output site/src/data/catalog.json

      - name: Validate PR testing results
        if: github.event_name == 'pull_request'
        run: |
          IMAGE_COUNT=$(jq length .verity/images.json)
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ### PR Testing Summary

          ✅ Copa bulk config pipeline tested successfully

          **Test Registry:** \`$REGISTRY\`
          **Images Processed:** \`$IMAGE_COUNT\`

          **Pipeline Steps Validated:**
          - ✅ Copa bulk patch
          - ✅ Image scanning (Trivy)
          - ✅ Catalog generation
          - ✅ Site build

          _Note: Signing/attestation skipped in PR mode_

          **Catalog Stats:**
          EOF
          jq -r '"- Total Images: \(.summary.totalImages)\n- Total Vulnerabilities: \(.summary.totalVulns)\n- Fixable: \(.summary.fixableVulns)"' site/src/data/catalog.json >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/setup-node@v6
        with:
          node-version-file: 'site/package.json'
          cache: 'npm'
          cache-dependency-path: site/package-lock.json

      - name: Build site
        working-directory: site
        run: npm ci && npm run build

      - name: Upload PR test artifacts
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: pr-test-results
          path: |
            .verity/images.json
            .verity/reports/*.json
            site/src/data/catalog.json
          retention-days: 7

      - name: Upload Pages artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-pages-artifact@v4
        with:
          path: site/dist

  deploy-site:
    name: Deploy Site
    needs: patch-and-publish
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - uses: actions/deploy-pages@v4
        id: deployment
