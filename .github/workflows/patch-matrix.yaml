name: Patch Images (Matrix)

# Matrix-based patching workflow for parallel execution:
# 1. Prepare: Warm mise tool caches on amd64 + arm64; mirror BuildKit image to GHCR
# 2. Scan: Generate Trivy reports, Copa dry-run discovery
# 3. Patch: Parallel matrix jobs patch individual images per platform (native builds)
#           Includes app-level patching (--pkg-types os,library, COPA_EXPERIMENTAL=1)
# 4. Combine: Create multi-platform manifest lists, sign with cosign
# 5. Attest: Attach CycloneDX SBOM attestations via actions/attest (parallel matrix)
# 6. Assemble: Post-patch scan, generate before/after catalog, build and upload site
# 7. Deploy: Publish site to GitHub Pages

on:
  schedule:
    - cron: '0 2 * * *'
  push:
    branches: [main]
    paths: ['copa-config.yaml', '.github/workflows/patch-matrix.yaml']
  pull_request:
    paths: ['copa-config.yaml', '.github/workflows/patch-matrix.yaml', 'internal/**', 'cmd/**']
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  id-token: write

env:
  # Target registry for final patched images
  TARGET_REGISTRY: ghcr.io/verity-org
  # GHCR staging registry for intermediate platform-specific images
  STAGING_REGISTRY: ghcr.io/verity-org/cache
  # BuildKit image mirrored to GHCR to avoid flaky pulls from mirror.gcr.io
  BUILDKIT_IMAGE: ghcr.io/verity-org/cache/buildkit:buildx-stable-1
  # Platforms to build: always test both amd64 + arm64 (even in PRs) to catch platform-specific issues early
  PLATFORMS: linux/amd64,linux/arm64

jobs:
  # ── Job 1: Warm caches on both arches + mirror BuildKit ────────────
  prepare:
    name: "Prepare (${{ matrix.runner }})"
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04
            do-mirror: true
          - runner: ubuntu-24.04-arm
            do-mirror: false

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install mise
        uses: step-security/mise-action@d65cf9dcb78b983ae2530c89fd28e72286713505 # v3.5.1
        with:
          install: true
          cache: true

      - name: Login to GHCR
        if: matrix.do-mirror
        uses: step-security/docker-login-action@c3e677aae8393bc9c81cfdf9709648720ea4bd4d # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Mirror BuildKit to GHCR
        if: matrix.do-mirror
        # crane copy is idempotent: skips blobs already in GHCR, so no digest check needed.
        # Fallback: if upstream is unreachable, succeed if the mirror already exists in GHCR.
        run: |
          crane copy mirror.gcr.io/moby/buildkit:buildx-stable-1 "${BUILDKIT_IMAGE}" \
            || crane digest "${BUILDKIT_IMAGE}" > /dev/null \
            || { echo "Error: no BuildKit available (upstream down, no GHCR mirror)"; exit 1; }

  # ── Job 2: Scan images and discover what needs patching ────────────
  scan:
    name: Scan & Discover
    needs: [prepare]
    runs-on: ubuntu-24.04
    outputs:
      matrix: ${{ steps.discover.outputs.matrix }}
      has_images: ${{ steps.discover.outputs.has_images }}
      has_catalog_images: ${{ steps.discover.outputs.has_catalog_images }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install mise
        uses: step-security/mise-action@d65cf9dcb78b983ae2530c89fd28e72286713505 # v3.5.1
        with:
          install: true
          cache: true

      - name: Cache Go modules
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/dev/go/pkg/mod
            ~/.cache/go-build
          key: go-${{ runner.os }}-${{ hashFiles('go.sum') }}
          restore-keys: go-${{ runner.os }}-

      - name: Login to GHCR
        uses: step-security/docker-login-action@c3e677aae8393bc9c81cfdf9709648720ea4bd4d # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup binaries
        uses: ./.github/actions/setup-binaries
        with:
          github-token: ${{ github.token }}

      - name: Get date for Trivy DB cache key
        id: trivy-date
        run: echo "date=$(date -u '+%Y-%m-%d-%H')" >> "$GITHUB_OUTPUT"

      - name: Cache Trivy database
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ steps.trivy-date.outputs.date }}
          restore-keys: |
            trivy-db-

      - name: Start Trivy server
        run: |
          trivy server --listen 0.0.0.0:4954 &
          timeout 60 bash -c 'until curl -f http://localhost:4954/healthz 2>/dev/null; do sleep 1; done'
          echo "✓ Trivy server ready"

      - name: Scan all images with Trivy
        run: |
          # Scan both source and patched images to detect if re-patching is needed
          # Copa's skip detection checks existing patched images for new vulnerabilities
          ./verity scan \
            --config copa-config.yaml \
            --target-registry "$TARGET_REGISTRY" \
            --trivy-server http://localhost:4954 \
            --parallel 10 \
            --output reports/

      - name: Run Copa dry-run discovery
        id: discover
        run: .github/scripts/copa-discover.sh copa-config.yaml reports/

      - name: Scan chart-discovered images
        run: .github/scripts/scan-chart-images.sh results.json reports/

      - name: Upload scan and discovery results
        if: always()
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: scan-results
          path: |
            reports/
            results.json
            matrix.json
          retention-days: 30

  # ── Job 3: Patch images in parallel per platform ───────────────────
  patch:
    name: "Patch ${{ matrix.name }}"
    needs: [scan]
    if: needs.scan.outputs.has_images == 'true'
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix: ${{ fromJson(needs.scan.outputs.matrix) }}
      fail-fast: false
      max-parallel: 10

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        id: checkout
        continue-on-error: true

      - name: Retry checkout on failure
        if: steps.checkout.outcome == 'failure'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install mise
        uses: step-security/mise-action@d65cf9dcb78b983ae2530c89fd28e72286713505 # v3.5.1
        with:
          install: true
          cache: true

      - name: Cache Go modules
        uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/dev/go/pkg/mod
            ~/.cache/go-build
          key: go-${{ runner.os }}-${{ hashFiles('go.sum') }}
          restore-keys: go-${{ runner.os }}-

      - name: Login to GHCR
        uses: step-security/docker-login-action@c3e677aae8393bc9c81cfdf9709648720ea4bd4d # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup BuildKit
        id: buildx-setup
        run: |
          # Create buildx builder (will inherit credentials from docker login)
          docker buildx create \
            --name copa-builder \
            --driver docker-container \
            --driver-opt network=host \
            --driver-opt "image=${BUILDKIT_IMAGE}" \
            --buildkitd-flags '--allow-insecure-entitlement network.host' \
            --use

          docker buildx inspect --bootstrap

      - name: Download scan results
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          name: scan-results
          path: .

      - name: Setup binaries
        uses: ./.github/actions/setup-binaries
        with:
          github-token: ${{ github.token }}

      - name: Patch image
        env:
          COPA_EXPERIMENTAL: "1"
          PLATFORM: ${{ matrix.platform }}
          SOURCE: ${{ matrix.source }}
          IMAGE_NAME: ${{ matrix.image }}
        run: .github/scripts/patch-image.sh

      - name: Generate patch report
        if: always()
        run: |
          mkdir -p patch-results
          echo '{"name": "${{ matrix.name }}", "image": "${{ matrix.image }}", "source": "${{ matrix.source }}", "target": "${{ matrix.target }}", "platform": "${{ matrix.platform }}", "status": "patched"}' \
            > patch-results/${{ matrix.name }}.json

      - name: Upload patch result
        if: always()
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: patch-result-${{ matrix.name }}
          path: patch-results/
          retention-days: 7

  # ── Job 4: Combine platform images into manifest lists ─────────────
  combine:
    name: Create Manifest Lists
    needs: [scan, patch]
    if: needs.scan.outputs.has_images == 'true' && needs.patch.result == 'success'
    runs-on: ubuntu-24.04
    outputs:
      has_manifests: ${{ steps.attestation-matrix.outputs.has_manifests }}
      attestation_matrix: ${{ steps.attestation-matrix.outputs.attestation_matrix }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install mise
        uses: step-security/mise-action@d65cf9dcb78b983ae2530c89fd28e72286713505 # v3.5.1
        with:
          install: true
          cache: true

      - name: Login to GHCR
        uses: step-security/docker-login-action@c3e677aae8393bc9c81cfdf9709648720ea4bd4d # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download patch results
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          pattern: patch-result-*
          path: patch-results/
          merge-multiple: true

      - name: Create manifest lists
        env:
          IS_PR: ${{ github.event_name == 'pull_request' }}
        run: .github/scripts/create-manifests.sh

      - name: Sign GHCR images
        if: github.event_name != 'pull_request'
        run: .github/scripts/sign-manifests.sh

      - name: Build attestation matrix
        id: attestation-matrix
        run: .github/scripts/build-attestation-matrix.sh

      - name: Generate manifest report
        env:
          IS_PR: ${{ github.event_name == 'pull_request' }}
        run: .github/scripts/generate-manifest-report.sh

      - name: Upload manifest results
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: manifest-results
          path: manifest-results/
          retention-days: 7

  # ── Job 5: Attest patched images with SBOM ────────────────────────
  attest:
    name: "Attest ${{ matrix.image }}"
    needs: combine
    if: needs.combine.outputs.has_manifests == 'true'
    runs-on: ubuntu-24.04
    strategy:
      matrix: ${{ fromJson(needs.combine.outputs.attestation_matrix) }}
      fail-fast: false
    permissions:
      id-token: write
      attestations: write
      packages: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: mise.toml
          sparse-checkout-cone-mode: false

      - name: Install mise
        uses: step-security/mise-action@d65cf9dcb78b983ae2530c89fd28e72286713505 # v3.5.1
        with:
          install: true
          cache: true

      - name: Login to GHCR
        uses: step-security/docker-login-action@c3e677aae8393bc9c81cfdf9709648720ea4bd4d # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate SBOM
        run: syft "${{ matrix.image }}@${{ matrix.digest }}" -o cyclonedx-json=sbom.json

      - name: Attest SBOM
        uses: actions/attest@59d89421af93a897026c735860bf21b6eb4f7b26 # v4.1.0
        with:
          subject-name: ${{ matrix.image }}
          subject-digest: ${{ matrix.digest }}
          predicate-type: https://cyclonedx.org/bom
          predicate-path: sbom.json
          push-to-registry: true

  # ── Job 6: Generate catalog (includes post-patch scan) ────────────
  assemble:
    name: Generate Catalog
    needs: [scan, combine]
    if: always() && needs.scan.outputs.has_catalog_images == 'true' && needs.combine.result != 'cancelled'
    runs-on: ubuntu-24.04
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install mise
        uses: step-security/mise-action@d65cf9dcb78b983ae2530c89fd28e72286713505 # v3.5.1
        with:
          install: true
          cache: true

      - name: Cache npm dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('site/package-lock.json') }}
          restore-keys: npm-${{ runner.os }}-

      - name: Cache Go modules
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/dev/go/pkg/mod
            ~/.cache/go-build
          key: go-${{ runner.os }}-${{ hashFiles('go.sum') }}
          restore-keys: go-${{ runner.os }}-

      - name: Login to GHCR
        uses: step-security/docker-login-action@c3e677aae8393bc9c81cfdf9709648720ea4bd4d # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup binaries
        uses: ./.github/actions/setup-binaries
        with:
          github-token: ${{ github.token }}

      - name: Download all patch results
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          pattern: patch-result-*
          path: patch-results/
          merge-multiple: true

      - name: Download scan results
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          name: scan-results
          path: .

      - name: Get date for Trivy DB cache key
        id: trivy-date
        run: echo "date=$(date -u '+%Y-%m-%d-%H')" >> "$GITHUB_OUTPUT"

      - name: Cache Trivy database
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ steps.trivy-date.outputs.date }}
          restore-keys: |
            trivy-db-

      - name: Start Trivy server
        if: needs.combine.result == 'success'
        run: |
          trivy server --listen 0.0.0.0:4954 &
          timeout 60 bash -c 'until curl -f http://localhost:4954/healthz 2>/dev/null; do sleep 1; done'
          echo "✓ Trivy server ready"

      - name: Scan patched images
        if: needs.combine.result == 'success'
        run: |
          ./verity scan \
            --config copa-config.yaml \
            --target-registry "$TARGET_REGISTRY" \
            --patched-only \
            --trivy-server http://localhost:4954 \
            --parallel 10 \
            --output post-reports/

      - name: Generate catalog
        run: .github/scripts/generate-catalog.sh results.json reports/ post-reports/ "$TARGET_REGISTRY" site/src/data/catalog.json

      - name: Build site
        working-directory: site
        run: npm ci && npm run build

      - name: Upload PR test artifacts
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: pr-test-results
          path: |
            .verity/images.json
            site/src/data/catalog.json
          retention-days: 7

      - name: Validate PR testing results
        if: github.event_name == 'pull_request'
        run: .github/scripts/pr-summary.sh "$TARGET_REGISTRY" .verity/images.json site/src/data/catalog.json

      - name: Upload Pages artifact
        uses: ./.github/actions/upload-pages-artifact
        with:
          path: site/dist
          overwrite: "true"

  # ── Job 7: Deploy catalog site to GitHub Pages ─────────────────────
  deploy-site:
    name: Deploy Site
    needs: assemble
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
        id: deployment
