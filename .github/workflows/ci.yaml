name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test ./...

  scan:
    name: Scan Chart Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build verity
        run: go build -o verity .

      - name: Scan charts for images
        run: ./verity -chart Chart.yaml -output charts

      - name: Show discovered images
        run: cat charts/*/values.yaml

  pull-images:
    name: Verify Docker Images
    runs-on: ubuntu-latest
    needs: scan
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build verity
        run: go build -o verity .

      - name: Scan charts for images
        run: ./verity -chart Chart.yaml -output charts

      - name: Pull all discovered images
        run: |
          set -euo pipefail
          failed=0
          while IFS= read -r line; do
            registry=$(echo "$line" | yq -r '.registry // ""')
            repository=$(echo "$line" | yq -r '.repository')
            tag=$(echo "$line" | yq -r '.tag // "latest"')

            if [ -n "$registry" ]; then
              ref="${registry}/${repository}:${tag}"
            else
              ref="${repository}:${tag}"
            fi

            echo "::group::Pulling ${ref}"
            if docker pull "$ref"; then
              echo "OK: ${ref}"
            else
              echo "::error::Failed to pull ${ref}"
              failed=1
            fi
            echo "::endgroup::"
          done < <(yq -o=json -I=0 '.images[]' charts/*/values.yaml)

          if [ "$failed" -ne 0 ]; then
            echo "::error::Some images failed to pull"
            exit 1
          fi
